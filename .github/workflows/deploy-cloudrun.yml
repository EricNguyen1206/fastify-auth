# .github/workflows/deploy-cloudrun.yml
name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch: # Manual trigger

env:
  PROJECT_ID: snack-survey-deff4
  REGION: asia-southeast1
  SERVICE_NAME: auth-service
  REPOSITORY: auth-service
  REGISTRY: asia-southeast1-docker.pkg.dev
  GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-key.json

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Permissions for GitHub Actions
    permissions:
      contents: read

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Validate GCP service account key secret
      - name: Validate GCP secret
        run: |
          if [ -z "${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}" ]; then
            echo "‚ùå Error: GOOGLE_APPLICATION_CREDENTIALS secret is not set or is empty"
            echo "Please set GOOGLE_APPLICATION_CREDENTIALS secret in GitHub repository settings:"
            echo "Settings > Secrets and variables > Actions > New repository secret"
            echo "Value should be the JSON content of your service account key file"
            exit 1
          fi
          # Validate JSON format
          echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}' | jq . > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è Warning: GOOGLE_APPLICATION_CREDENTIALS may not be valid JSON, but continuing..."
          fi
          echo "‚úÖ GOOGLE_APPLICATION_CREDENTIALS secret is set"

      # Step 3: Create service account key file from secret
      - name: Create service account key file
        run: |
          echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}' | jq . > ${{ env.GOOGLE_APPLICATION_CREDENTIALS }} || \
          echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}' > ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
          chmod 600 ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
          echo "‚úÖ Service account key file created at ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}"
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}

      # Step 4: Authenticate to Google Cloud using service account key file
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}

      # Step 5: Setup Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      # Step 6: Create Artifact Registry repository (if not exists)
      - name: Create Artifact Registry repository
        run: |
          gcloud artifacts repositories describe ${{ env.REPOSITORY }} \
            --location=${{ env.REGION }} \
            --format="value(name)" || \
          gcloud artifacts repositories create ${{ env.REPOSITORY }} \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="Docker images for Cloud Run services" \
            --quiet

      # Step 7: Configure Docker to use Artifact Registry
      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      # Step 8: Set image tags
      - name: Set image tags
        id: image-tags
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_LATEST=latest
          IMAGE_SHORT_SHA=${IMAGE_TAG:0:7}
          
          FULL_IMAGE_TAG="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${IMAGE_TAG}"
          FULL_IMAGE_LATEST="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${IMAGE_LATEST}"
          FULL_IMAGE_SHORT="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${IMAGE_SHORT_SHA}"
          
          echo "full_tag=${FULL_IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "latest_tag=${FULL_IMAGE_LATEST}" >> $GITHUB_OUTPUT
          echo "short_tag=${FULL_IMAGE_SHORT}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      # Step 9: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      # Step 10: Build and push Docker image with cache
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.image-tags.outputs.full_tag }}
            ${{ steps.image-tags.outputs.latest_tag }}
            ${{ steps.image-tags.outputs.short_tag }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:buildcache,mode=max
          build-args: |
            NODE_ENV=production

      # Step 11: Deploy to Cloud Run
      - name: Deploy to Cloud Run
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ steps.image-tags.outputs.full_tag }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 300 \
            --concurrency 80 \
            --port 8080 \
            --set-env-vars NODE_ENV=production,PORT=8080,HOST=0.0.0.0,LOG_LEVEL=info \
            --update-secrets DATABASE_URI=DATABASE_URI:latest,JWT_SECRET=JWT_SECRET:latest,COOKIE_SECRET=COOKIE_SECRET:latest \
            --quiet

      # Step 12: Show service URL and info
      - name: Show Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "‚úÖ Deployment successful!"
          echo "üåê Service URL: $SERVICE_URL"
          echo "üì¶ Image: ${{ steps.image-tags.outputs.full_tag }}"
          echo "üîó Health check: $SERVICE_URL/health"
          
      # Step 13: Test health endpoint (optional)
      - name: Test health endpoint
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          sleep 10  # Wait for service to be ready
          curl -f "$SERVICE_URL/health" || echo "‚ö†Ô∏è Health check failed, but deployment succeeded"