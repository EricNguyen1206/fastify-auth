# .github/workflows/deploy-cloudrun.yml
name: Deploy to Cloud Run

on:
  # Trigger after successful build
  workflow_run:
    workflows: ["Build and Push Image"]
    types:
      - completed
    branches:
      - main
      - develop
  
  # Manual trigger with optional image tag
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (leave empty for latest)'
        required: false
        type: string

env:
  PROJECT_ID: snack-survey-deff4
  REGION: asia-southeast1
  SERVICE_NAME: auth-service
  REPOSITORY: auth-service
  REGISTRY: asia-southeast1-docker.pkg.dev
  GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-key.json

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Only run if build workflow succeeded or manual dispatch
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    permissions:
      contents: read

    steps:
      # Step 1: Checkout code (needed for potential rollback info)
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Validate GCP service account key secret
      - name: Validate GCP secret
        run: |
          if [ -z "${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}" ]; then
            echo "âŒ Error: GOOGLE_APPLICATION_CREDENTIALS secret is not set or is empty"
            echo "Please set GOOGLE_APPLICATION_CREDENTIALS secret in GitHub repository settings"
            exit 1
          fi
          echo "âœ… GOOGLE_APPLICATION_CREDENTIALS secret is set"

      # Step 3: Create service account key file
      - name: Create service account key file
        run: |
          echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}' | jq . > ${{ env.GOOGLE_APPLICATION_CREDENTIALS }} || \
          echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}' > ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
          chmod 600 ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
          echo "âœ… Service account key file created"

      # Step 4: Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      # Step 5: Setup Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      # Step 6: Determine image tag to deploy
      - name: Determine image tag
        id: image
        run: |
          # If manual dispatch with custom tag, use it
          if [ -n "${{ inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
            echo "ðŸŽ¯ Using manual image tag: ${IMAGE_TAG}"
          # If triggered by workflow_run, use the commit SHA from that run
          elif [ "${{ github.event_name }}" == "workflow_run" ]; then
            IMAGE_TAG="${{ github.event.workflow_run.head_sha }}"
            echo "ðŸŽ¯ Using image tag from build workflow: ${IMAGE_TAG}"
          # Fallback to latest
          else
            IMAGE_TAG="latest"
            echo "ðŸŽ¯ Using latest image tag"
          fi
          
          FULL_IMAGE_TAG="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${IMAGE_TAG}"
          echo "full_tag=${FULL_IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Deploying image: ${FULL_IMAGE_TAG}"

      # Step 7: Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ steps.image.outputs.full_tag }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 300 \
            --concurrency 80 \
            --port 8080 \
            --set-env-vars NODE_ENV=production,HOST=0.0.0.0,LOG_LEVEL=info \
            --update-secrets DATABASE_URI=DATABASE_URI:latest,JWT_SECRET=JWT_SECRET:latest,COOKIE_SECRET=COOKIE_SECRET:latest \
            --quiet

      # Step 8: Show service URL and info
      - name: Show Service URL
        id: service-info
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Service URL: $SERVICE_URL"
          echo "ðŸ“¦ Image: ${{ steps.image.outputs.full_tag }}"
          echo "ðŸ”— Health check: $SERVICE_URL/health"
          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          
      # Step 9: Test health endpoint
      - name: Test health endpoint
        run: |
          SERVICE_URL="${{ steps.service-info.outputs.service_url }}"
          echo "â³ Waiting for service to be ready..."
          sleep 10
          
          echo "ðŸ” Testing health endpoint: $SERVICE_URL/health"
          if curl -f "$SERVICE_URL/health"; then
            echo "âœ… Health check passed!"
          else
            echo "âš ï¸ Health check failed, but deployment succeeded"
            echo "This may be normal if the service needs more time to start"
            exit 0
          fi

      # Step 10: Deployment summary
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ steps.image.outputs.full_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.service-info.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Service URL](${{ steps.service-info.outputs.service_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Health Check](${{ steps.service-info.outputs.service_url }}/health)" >> $GITHUB_STEP_SUMMARY