
> fastify-auth@1.0.0 test
> cross-env NODE_OPTIONS=--experimental-vm-modules npx jest --detectOpenHandles --forceExit

npm : (node:2680) 
ExperimentalWarning: VM 
Modules is an experimental 
feature and might change at 
any time
At line:1 char:1
+ npm test 2>&1 | Out-File 
-FilePath test-full-output.txt 
-Encoding utf ...
+ ~~~~~~~~~~~~~
    + CategoryInfo          :  
   NotSpecified: ((node:2680)  
   Exp...nge at any time:Str   
 ing) [], RemoteException
    + FullyQualifiedErrorId :  
   NativeCommandError
 
(Use `node --trace-warnings 
...` to show where the warning 
was created)
PASS src/tests/unit/repositorie
s/session.repository.test.js
  Session Repository - 
createSession()
    竏・should create session 
with refresh token and expiry 
(12 ms)
    竏・should link session to 
user ID (2 ms)
  Session Repository - 
findSessionByToken()
    竏・should return session 
when token valid and not 
expired (2 ms)
    竏・should return null when 
token not found (2 ms)
    竏・should return null when 
session expired (3 ms)
    竏・should validate user ID 
ownership (3 ms)
    竏・should use gt (greater 
than) for expiry check (2 ms)
  Session Repository - 
deleteSession()
    竏・should delete session by 
refresh token (2 ms)
    竏・should return delete 
count (3 ms)
    竏・should handle deleting 
non-existent session (2 ms)
  Session Repository - 
deleteUserSessions()
    竏・should delete all 
sessions for user (3 ms)
    竏・should return count of 
deleted sessions (2 ms)
    竏・should return 0 when 
user has no sessions (2 ms)
  Session Repository - 
cleanExpiredSessions()
    竏・should delete only 
expired sessions (2 ms)
    竏・should use lt (less 
than) for expiry check (2 ms)
    竏・should return count of 
cleaned sessions (2 ms)
    竏・should return 0 when no 
expired sessions exist (2 ms)

PASS src/tests/unit/services/au
th.service.test.js
  Auth Service - signup()
    竏・should successfully 
create user with hashed 
password (6 ms)
    竏・should throw 409 error 
when email already exists (2 
ms)
    竏・should hash password 
with bcrypt salt rounds of 10 
(3 ms)
  Auth Service - signin()
    竏・should successfully 
authenticate with valid 
credentials (3 ms)
    竏・should return user 
without password field (3 ms)
    竏・should throw 401 when 
user not found (2 ms)
    竏・should throw 401 when 
password is invalid (3 ms)
  Auth Service - 
createAuthSession()
    竏・should create access and 
refresh tokens (3 ms)
    竏・should store session in 
database (6 ms)
    竏・should set correct token 
expiry (7 days) (2 ms)
  Auth Service - 
refreshAccessToken()
    竏・should return new access 
token with valid refresh token 
(2 ms)
    竏・should throw 401 when 
refresh token is missing (2 ms)
    竏・should throw 401 when 
token type is not refresh (1 
ms)
    竏・should throw 401 when 
session not found in DB (1 ms)
    竏・should throw 401 when 
token signature is invalid (1 
ms)
  Auth Service - signout()
    竏・should delete session 
when refresh token provided (1 
ms)
    竏・should handle missing 
refresh token gracefully (2 ms)

PASS src/tests/unit/repositorie
s/user.repository.test.js
  User Repository - 
createUser()
    竏・should create user with 
correct data (5 ms)
    竏・should exclude password 
from returned object (2 ms)
    竏・should include id, 
email, name, createdAt (2 ms)
  User Repository - 
findUserByEmail()
    竏・should return user with 
password when found (2 ms)
    竏・should return null when 
not found (2 ms)
  User Repository - 
findUserById()
    竏・should return user 
without password when found (2 
ms)
    竏・should return null when 
not found (2 ms)
  User Repository - 
updateUser()
    竏・should update user data 
correctly (2 ms)
    竏・should return updated 
user without password (2 ms)
  User Repository - 
emailExists()
    竏・should return true when 
email exists (2 ms)
    竏・should return false when 
email does not exist (2 ms)
    竏・should return true when 
multiple users exist with same 
email (1 ms)

PASS src/tests/integration/rout
es/user/profile.route.test.js
  Profile Route - GET 
/user/profile
    竏・should return user 
profile when authenticated (7 
ms)
    竏・should use userId from 
request.user (2 ms)
    竏・should throw 404 when 
user not found (3 ms)
  Profile Route - PUT 
/user/profile
    竏・should update name 
successfully (2 ms)
    竏・should validate name min 
length (2) (2 ms)
    竏・should log profile 
update (2 ms)
    竏・should handle empty 
update data (2 ms)

PASS src/tests/unit/services/us
er.service.test.js
  User Service - 
getUserProfile()
    竏・should return user 
profile when user exists (5 ms)
    竏・should throw 404 when 
user not found (3 ms)
  User Service - 
updateUserProfile()
    竏・should update user 
profile with valid data (2 ms)
    竏・should only update 
whitelisted fields (name) (2 
ms)
    竏・should return unchanged 
profile when no valid updates 
provided (2 ms)
    竏・should filter out 
non-allowed fields (4 ms)
    竏・should handle empty name 
and return unchanged profile 
(7 ms)

PASS src/tests/integration/rout
es/auth/refresh.route.test.js
  Refresh Route - POST 
/auth/refresh
    竏・should return new access 
token with valid refresh token 
(5 ms)
    竏・should return 401 when 
refresh token missing (3 ms)
    竏・should return 401 when 
refresh token invalid (2 ms)
    竏・should clear cookies on 
error (5 ms)
    竏・should log successful 
token refresh (2 ms)

PASS src/tests/integration/rout
es/auth/signup.route.test.js
  Signup Route - POST 
/auth/signup
    竏・should successfully 
register a new user (201) (5 
ms)
    竏・should validate email 
format (2 ms)
    竏・should validate password 
min length (8) (1 ms)
    竏・should validate name min 
length (2) (2 ms)
    竏・should return 409 for 
duplicate email (2 ms)
    竏・should require all 
fields (2 ms)
    竏・should log successful 
registration (2 ms)

PASS src/tests/integration/rout
es/auth/signin.route.test.js
  Signin Route - POST 
/auth/signin
    竏・should successfully 
login with valid credentials 
(5 ms)
    竏・should set access token 
cookie (2 ms)
    竏・should set refresh token 
cookie (2 ms)
    竏・should return 401 for 
invalid email (3 ms)
    竏・should return 401 for 
invalid password (2 ms)
    竏・should log successful 
signin (2 ms)
    竏・should have rate 
limiting configured (5 
attempts per 15 minutes) (2 ms)

PASS src/tests/integration/rout
es/auth/signout.route.test.js
  Signout Route - POST 
/auth/signout
    竏・should successfully log 
out user (5 ms)
    竏・should clear cookies (1 
ms)
    竏・should delete session 
from database (1 ms)
    竏・should require 
authentication (preHandler) (1 
ms)
    竏・should log successful 
signout (2 ms)
    竏・should handle signout 
even without refresh token (2 
ms)

PASS src/tests/unit/middlewares
/auth.middleware.test.js
  Auth Middleware - 
authenticate()
    竏・should call jwtVerify 
with onlyCookie option (7 ms)
    竏・should pass when JWT is 
valid (2 ms)
    竏・should return 401 error 
with correct message when JWT 
invalid (1 ms)
    竏・should handle expired 
JWT tokens (1 ms)
    竏・should handle missing 
JWT tokens (2 ms)
    竏・should handle malformed 
JWT tokens (2 ms)

Test Suites: 10 passed, 10 
total
Tests:       91 passed, 91 
total
Snapshots:   0 total
Time:        2.345 s
Ran all test suites.
