# Vector Configuration for Log Collection and Forwarding
# Collects logs from Fastify app container stdout and forwards to Loki

[sources.docker_logs]
type = "docker_logs"
# This will collect logs from all containers, but we'll filter for our app
include_containers = ["fastify-auth-app-1", "app"]

[transforms.parse_json]
type = "remap"
inputs = ["docker_logs"]
source = '''
# Parse JSON logs from Pino
. = parse_json!(.message)

# Add container labels
.container_name = .container_name
.container_id = .container_id

# Ensure timestamp is properly formatted
if !exists(.time) {
  .time = now()
}
'''

[transforms.add_labels]
type = "remap"
inputs = ["parse_json"]
source = '''
# Add static labels for Loki
.application = "fastify-auth"
.environment = "development"
.service = "authentication"
'''

[sinks.loki]
type = "loki"
inputs = ["add_labels"]
# For Grafana Cloud: Replace with your Grafana Cloud Loki endpoint
# Example: https://logs-prod-XXX.grafana.net/loki/api/v1/push
# For local: http://loki:3101
endpoint = "http://loki:3101"
encoding.codec = "json"
labels.application = "{{ application }}"
labels.environment = "{{ environment }}"
labels.service = "{{ service }}"
labels.container_name = "{{ container_name }}"
# Include trace context for correlation
labels.trace_id = "{{ trace_id }}"
labels.span_id = "{{ span_id }}"

# For Grafana Cloud, add authentication headers:
# [sinks.loki.auth]
# strategy = "basic"
# user = "${GRAFANA_CLOUD_LOKI_USERNAME}"
# password = "${GRAFANA_CLOUD_LOKI_PASSWORD}"

# Batch settings for performance
batch.max_bytes = 1048576  # 1MB
batch.timeout_secs = 5

# Retry and buffer settings
buffer.type = "memory"
buffer.max_events = 10000

[sinks.console]
type = "console"
inputs = ["add_labels"]
encoding.codec = "json"
# Only enable in development for debugging
